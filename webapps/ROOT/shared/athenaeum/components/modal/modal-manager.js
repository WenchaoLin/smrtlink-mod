"use strict";
var Rx_1 = require("rxjs/Rx");
var ModalManager = (function () {
    function ModalManager() {
        this._modalsShowing = [];
    }
    ModalManager.prototype.registerUnderlay = function (underlay) {
        if (this._underlay) {
            throw new Error("Only one pb-modal-underlay may be registered in an application");
        }
        this._underlay = underlay;
    };
    ModalManager.prototype.showingModal = function (modal) {
        return this._modalsShowing
            .findIndex(function (record) { return record.modal === modal; }) > -1;
    };
    ModalManager.prototype.show = function (modal) {
        var _this = this;
        if (!this._underlay) {
            throw new Error("No pb-modal-underlay has been registered! Ensure one " +
                "exists in the application and that it has been placed in " +
                "the template before any dialogs.");
        }
        if (this._hiddenHandle) {
            this._hiddenHandle.unsubscribe();
        }
        this._modalsShowing.forEach(function (record) {
            if (record.shownHandle) {
                record.shownHandle.unsubscribe();
            }
        });
        var record = { modal: modal };
        var length = (function () {
            var length = _this._modalsShowing.length;
            var last = _this._modalsShowing[length - 1];
            if (last && last.modal === modal) {
                return length;
            }
            return _this._modalsShowing.push(record);
        })();
        var zIndex = length * 1000;
        var previous = this._modalsShowing[length - 2];
        var handle = new Rx_1.Subscription(function () {
            if (handle === record.shownHandle) {
                record.shownHandle = null;
            }
            handle = null;
        });
        handle.add(this._underlay.shownEvent.subscribe(function () {
            handle.unsubscribe();
            if (previous) {
                previous.modal.doHide();
            }
            modal.doShow(zIndex);
        }));
        record.shownHandle = handle;
        this._underlay.show();
    };
    ModalManager.prototype.hide = function (modal) {
        var _this = this;
        if (!this._underlay) {
            throw new Error("No pb-modal-underlay has been registered! Ensure one " +
                "exists in the application and that it has been placed in " +
                "the template before any dialogs.");
        }
        if (this._hiddenHandle) {
            this._hiddenHandle.unsubscribe();
        }
        this._modalsShowing.forEach(function (record) {
            if (record.shownHandle) {
                record.shownHandle.unsubscribe();
            }
        });
        var index = this._modalsShowing
            .findIndex(function (record) { return record.modal === modal; });
        if (index > -1) {
            var record = this._modalsShowing.splice(index, 1)[0];
            if (!record.modal.hidden) {
                var handle_1 = new Rx_1.Subscription(function () {
                    if (handle_1 === _this._hiddenHandle) {
                        _this._hiddenHandle = null;
                    }
                    handle_1 = null;
                });
                handle_1.add(record.modal.hiddenEvent.subscribe(function () {
                    handle_1.unsubscribe();
                    var last = _this._modalsShowing[_this._modalsShowing.length - 1];
                    if (!last) {
                        _this._underlay.hide();
                    }
                    else if (last.modal.hidden) {
                        last.modal.show();
                    }
                }));
                this._hiddenHandle = handle_1;
                record.modal.doHide();
            }
        }
        else {
            var last = this._modalsShowing[this._modalsShowing.length - 1];
            if (!last) {
                this._underlay.hide();
            }
            else if (last.modal.hidden) {
                last.modal.show();
            }
        }
    };
    return ModalManager;
}());
exports.ModalManager = ModalManager;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbXBvbmVudHMvbW9kYWwvbW9kYWwtbWFuYWdlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBRUEsbUJBQTJCLFNBQVMsQ0FBQyxDQUFBO0FBT3JDO0lBQUE7UUFFWSxtQkFBYyxHQUFtQixFQUFFLENBQUM7SUEySWhELENBQUM7SUF4SUcsdUNBQWdCLEdBQWhCLFVBQWlCLFFBQXVCO1FBQ3BDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO1lBQ2pCLE1BQU0sSUFBSSxLQUFLLENBQ1gsZ0VBQWdFLENBQ25FLENBQUM7UUFDTixDQUFDO1FBQ0QsSUFBSSxDQUFDLFNBQVMsR0FBRyxRQUFRLENBQUM7SUFDOUIsQ0FBQztJQUVELG1DQUFZLEdBQVosVUFBYSxLQUFrQjtRQUMzQixNQUFNLENBQUMsSUFBSSxDQUFDLGNBQWM7YUFDckIsU0FBUyxDQUFDLFVBQUEsTUFBTSxJQUFJLE9BQUEsTUFBTSxDQUFDLEtBQUssS0FBSyxLQUFLLEVBQXRCLENBQXNCLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztJQUMxRCxDQUFDO0lBRUQsMkJBQUksR0FBSixVQUFLLEtBQWtCO1FBQXZCLGlCQTBEQztRQXpERyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO1lBU2xCLE1BQU0sSUFBSSxLQUFLLENBQ1gsdURBQXVEO2dCQUN2RCwyREFBMkQ7Z0JBQzNELGtDQUFrQyxDQUNyQyxDQUFDO1FBQ04sQ0FBQztRQUVELEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDO1lBQ3JCLElBQUksQ0FBQyxhQUFhLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDckMsQ0FBQztRQUNELElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLFVBQUEsTUFBTTtZQUM5QixFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQztnQkFDckIsTUFBTSxD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WUFDeEQsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO2dCQUNSLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDMUIsQ0FBQztZQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7Z0JBQzNCLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDdEIsQ0FBQztRQUNMLENBQUM7SUFDTCxDQUFDO0lBQ0wsbUJBQUM7QUFBRCxDQTdJQSxBQTZJQyxJQUFBO0FBN0lZLG9CQUFZLGVBNkl4QixDQUFBIiwiZmlsZSI6ImNvbXBvbmVudHMvbW9kYWwvbW9kYWwtbWFuYWdlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7TW9kYWxVbmRlcmxheX0gZnJvbSBcIi4vbW9kYWwtdW5kZXJsYXlcIjtcbmltcG9ydCB7TW9kYWxEaWFsb2d9IGZyb20gXCIuL21vZGFsLWRpYWxvZ1wiO1xuaW1wb3J0IHtTdWJzY3JpcHRpb259IGZyb20gXCJyeGpzL1J4XCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgSU1vZGFsUmVjb3JkIHtcbiAgICBtb2RhbDogTW9kYWxEaWFsb2c7XG4gICAgc2hvd25IYW5kbGU/OiBTdWJzY3JpcHRpb247XG59XG5cbmV4cG9ydCBjbGFzcyBNb2RhbE1hbmFnZXIge1xuICAgIHByaXZhdGUgX3VuZGVybGF5OiBNb2RhbFVuZGVybGF5O1xuICAgIHByaXZhdGUgX21vZGFsc1Nob3dpbmc6IElNb2RhbFJlY29yZFtdID0gW107XG4gICAgcHJpdmF0ZSBfaGlkZGVuSGFuZGxlOiBTdWJzY3JpcHRpb247XG5cbiAgICByZWdpc3RlclVuZGVybGF5KHVuZGVybGF5OiBNb2RhbFVuZGVybGF5KSB7XG4gICAgICAgIGlmICh0aGlzLl91bmRlcmxheSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICAgICAgIFwiT25seSBvbmUgcGItbW9kYWwtdW5kZXJsYXkgbWF5IGJlIHJlZ2lzdGVyZWQgaW4gYW4gYXBwbGljYXRpb25cIlxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLl91bmRlcmxheSA9IHVuZGVybGF5O1xuICAgIH1cblxuICAgIHNob3dpbmdNb2RhbChtb2RhbDogTW9kYWxEaWFsb2cpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX21vZGFsc1Nob3dpbmdcbiAgICAgICAgICAgIC5maW5kSW5kZXgocmVjb3JkID0+IHJlY29yZC5tb2RhbCA9PT0gbW9kYWwpID4gLTE7XG4gICAgfVxuXG4gICAgc2hvdyhtb2RhbDogTW9kYWxEaWFsb2cpIHtcbiAgICAgICAgaWYgKCF0aGlzLl91bmRlcmxheSkge1xuICAgICAgICAgICAgLy8gVGhpcyBlcnJvciB3aWxsIG9ubHkgb2NjdXIgaWYgYSBkaWFsb2cgaXMgY3JlYXRlZCBiZWZvcmUgdGhlXG4gICAgICAgICAgICAvLyB1bmRlcmxheSBhbmQgYSBzdGF0ZW1lbnQgaW4gbmdPbkluaXQoKSBjYXVzZXMgdGhlIGRpYWxvZyB0byB1c2VcbiAgICAgICAgICAgIC8vIHRoZSB1bmRlcmxheSBiZWZvcmUgdGhlIHVuZGVybGF5IGlzIGNyZWF0ZWQuIFRvIHByZXZlbnQgdGhpc1xuICAgICAgICAgICAgLy8gZXJyb3IsIGRpYWxvZ3MgaW4gdGhlIHNhbWUgdGVtcGxhdGUgYXMgdGhlIHVuZGVybGF5IE1VU1QgYmVcbiAgICAgICAgICAgIC8vIHBsYWNlcyBBRlRFUiB0aGUgdW5kZXJsYXk6XG4gICAgICAgICAgICAvL1xuICAgICAgICAgICAgLy8gPHBiLW1vZGFsLXVuZGVybGF5PjwvcGItbW9kYWwtdW5kZXJsYXk+XG4gICAgICAgICAgICAvLyA8cGItbW9kYWwtZGlhbG9nPjwvcGItbW9kYWwtZGlhbG9nPlxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICAgICAgIFwiTm8gcGItbW9kYWwtdW5kZXJsYXkgaGFzIGJlZW4gcmVnaXN0ZXJlZCEgRW5zdXJlIG9uZSBcIiArXG4gICAgICAgICAgICAgICAgXCJleGlzdHMgaW4gdGhlIGFwcGxpY2F0aW9uIGFuZCB0aGF0IGl0IGhhcyBiZWVuIHBsYWNlZCBpbiBcIiArXG4gICAgICAgICAgICAgICAgXCJ0aGUgdGVtcGxhdGUgYmVmb3JlIGFueSBkaWFsb2dzLlwiXG4gICAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMuX2hpZGRlbkhhbmRsZSkge1xuICAgICAgICAgICAgdGhpcy5faGlkZGVuSGFuZGxlLnVuc3Vic2NyaWJlKCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5fbW9kYWxzU2hvd2luZy5mb3JFYWNoKHJlY29yZCA9PiB7XG4gICAgICAgICAgICBpZiAocmVjb3JkLnNob3duSGFuZGxlKSB7XG4gICAgICAgICAgICAgICAgcmVjb3JkLnNob3duSGFuZGxlLnVuc3Vic2NyaWJlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IHJlY29yZDogSU1vZGFsUmVjb3JkID0geyBtb2RhbCB9O1xuICAgICAgICBjb25zdCBsZW5ndGggPSAoKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgbGVuZ3RoID0gdGhpcy5fbW9kYWxzU2hvd2luZy5sZW5ndGg7XG4gICAgICAgICAgICBjb25zdCBsYXN0ID0gdGhpcy5fbW9kYWxzU2hvd2luZ1tsZW5ndGggLSAxXTtcblxuICAgICAgICAgICAgLy8gSWYgdGhlIG1vZGFsIGJlaW5nIHNob3duIGlzIGFscmVhZHkgdGhlIHRvcCBtb2RhbCxcbiAgICAgICAgICAgIC8vIGRvbid0IHB1c2ggaXQgb24gdGhlIHN0YWNrIGFnYWluXG4gICAgICAgICAgICBpZiAobGFzdCAmJiBsYXN0Lm1vZGFsID09PSBtb2RhbCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBsZW5ndGg7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fbW9kYWxzU2hvd2luZy5wdXNoKHJlY29yZCk7XG4gICAgICAgIH0pKCk7XG4gICAgICAgIGNvbnN0IHpJbmRleCA9IGxlbmd0aCAqIDEwMDA7XG4gICAgICAgIGNvbnN0IHByZXZpb3VzID0gdGhpcy5fbW9kYWxzU2hvd2luZ1tsZW5ndGggLSAyXTtcblxuICAgICAgICBsZXQgaGFuZGxlID0gbmV3IFN1YnNjcmlwdGlvbigoKSA9PiB7XG4gICAgICAgICAgICBpZiAoaGFuZGxlID09PSByZWNvcmQuc2hvd25IYW5kbGUpIHtcbiAgICAgICAgICAgICAgICByZWNvcmQuc2hvd25IYW5kbGUgPSBudWxsO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaGFuZGxlID0gbnVsbDtcbiAgICAgICAgfSk7XG4gICAgICAgIGhhbmRsZS5hZGQodGhpcy5fdW5kZXJsYXkuc2hvd25FdmVudC5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgICAgICAgaGFuZGxlLnVuc3Vic2NyaWJlKCk7XG5cbiAgICAgICAgICAgIGlmIChwcmV2aW91cykge1xuICAgICAgICAgICAgICAgIHByZXZpb3VzLm1vZGFsLmRvSGlkZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbW9kYWwuZG9TaG93KHpJbmRleCk7XG4gICAgICAgIH0pKTtcbiAgICAgICAgcmVjb3JkLnNob3duSGFuZGxlID0gaGFuZGxlO1xuXG4gICAgICAgIHRoaXMuX3VuZGVybGF5LnNob3coKTtcbiAgICB9XG5cbiAgICBoaWRlKG1vZGFsOiBNb2RhbERpYWxvZykge1xuICAgICAgICBpZiAoIXRoaXMuX3VuZGVybGF5KSB7XG4gICAgICAgICAgICAvLyBUaGlzIGVycm9yIHdpbGwgb25seSBvY2N1ciBpZiBhIGRpYWxvZyBpcyBjcmVhdGVkIGJlZm9yZSB0aGVcbiAgICAgICAgICAgIC8vIHVuZGVybGF5IGFuZCBhIHN0YXRlbWVudCBpbiBuZ09uSW5pdCgpIGNhdXNlcyB0aGUgZGlhbG9nIHRvIHVzZVxuICAgICAgICAgICAgLy8gdGhlIHVuZGVybGF5IGJlZm9yZSB0aGUgdW5kZXJsYXkgaXMgY3JlYXRlZC4gVG8gcHJldmVudCB0aGlzXG4gICAgICAgICAgICAvLyBlcnJvciwgZGlhbG9ncyBpbiB0aGUgc2FtZSB0ZW1wbGF0ZSBhcyB0aGUgdW5kZXJsYXkgTVVTVCBiZVxuICAgICAgICAgICAgLy8gcGxhY2VzIEFGVEVSIHRoZSB1bmRlcmxheTpcbiAgICAgICAgICAgIC8vXG4gICAgICAgICAgICAvLyA8cGItbW9kYWwtdW5kZXJsYXk+PC9wYi1tb2RhbC11bmRlcmxheT5cbiAgICAgICAgICAgIC8vIDxwYi1tb2RhbC1kaWFsb2c+PC9wYi1tb2RhbC1kaWFsb2c+XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgICAgICAgXCJObyBwYi1tb2RhbC11bmRlcmxheSBoYXMgYmVlbiByZWdpc3RlcmVkISBFbnN1cmUgb25lIFwiICtcbiAgICAgICAgICAgICAgICBcImV4aXN0cyBpbiB0aGUgYXBwbGljYXRpb24gYW5kIHRoYXQgaXQgaGFzIGJlZW4gcGxhY2VkIGluIFwiICtcbiAgICAgICAgICAgICAgICBcInRoZSB0ZW1wbGF0ZSBiZWZvcmUgYW55IGRpYWxvZ3MuXCJcbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5faGlkZGVuSGFuZGxlKSB7XG4gICAgICAgICAgICB0aGlzLl9oaWRkZW5IYW5kbGUudW5zdWJzY3JpYmUoKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLl9tb2RhbHNTaG93aW5nLmZvckVhY2gocmVjb3JkID0+IHtcbiAgICAgICAgICAgIGlmIChyZWNvcmQuc2hvd25IYW5kbGUpIHtcbiAgICAgICAgICAgICAgICByZWNvcmQuc2hvd25IYW5kbGUudW5zdWJzY3JpYmUoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29uc3QgaW5kZXggPSB0aGlzLl9tb2RhbHNTaG93aW5nXG4gICAgICAgICAgICAuZmluZEluZGV4KHJlY29yZCA9PiByZWNvcmQubW9kYWwgPT09IG1vZGFsKTtcbiAgICAgICAgaWYgKGluZGV4ID4gLTEpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlY29yZCA9IHRoaXMuX21vZGFsc1Nob3dpbmcuc3BsaWNlKGluZGV4LCAxKVswXTtcbiAgICAgICAgICAgIGlmICghcmVjb3JkLm1vZGFsLmhpZGRlbikge1xuICAgICAgICAgICAgICAgIGxldCBoYW5kbGUgPSBuZXcgU3Vic2NyaXB0aW9uKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGhhbmRsZSA9PT0gdGhpcy5faGlkZGVuSGFuZGxlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9oaWRkZW5IYW5kbGUgPSBudWxsO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGhhbmRsZSA9IG51bGw7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgaGFuZGxlLmFkZChyZWNvcmQubW9kYWwuaGlkZGVuRXZlbnQuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaGFuZGxlLnVuc3Vic2NyaWJlKCk7XG5cbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbGFzdCA9IHRoaXMuX21vZGFsc1Nob3dpbmdbXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9tb2RhbHNTaG93aW5nLmxlbmd0aCAtIDFcbiAgICAgICAgICAgICAgICAgICAgXTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFsYXN0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl91bmRlcmxheS5oaWRlKCk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobGFzdC5tb2RhbC5oaWRkZW4pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxhc3QubW9kYWwuc2hvdygpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSkpO1xuICAgICAgICAgICAgICAgIHRoaXMuX2hpZGRlbkhhbmRsZSA9IGhhbmRsZTtcbiAgICAgICAgICAgICAgICByZWNvcmQubW9kYWwuZG9IaWRlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zdCBsYXN0ID1cbiAgICAgICAgICAgICAgICB0aGlzLl9tb2RhbHNTaG93aW5nW3RoaXMuX21vZGFsc1Nob3dpbmcubGVuZ3RoIC0gMV07XG4gICAgICAgICAgICBpZiAoIWxhc3QpIHtcbiAgICAgICAgICAgICAgICB0aGlzLl91bmRlcmxheS5oaWRlKCk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGxhc3QubW9kYWwuaGlkZGVuKSB7XG4gICAgICAgICAgICAgICAgbGFzdC5tb2RhbC5zaG93KCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=