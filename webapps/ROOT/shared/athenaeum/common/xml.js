"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var escapeXMLMap = {
    "&": "&amp;",
    "\"": "&quot;",
    "'": "&apos;",
    "<": "&lt;",
    ">": "&gt;"
};
var unescapeXMLMap = {
    "&amp;": "&",
    "&quot;": "\"",
    "&apos;": "'",
    "&lt;": "<",
    "&gt;": ">"
};
var escapeXMLRE = /[&"'<>]/g;
var unescapeXMLRE = /&(?:amp|quot|apos|lt|gt);/g;
var XMLElement = (function () {
    function XMLElement(node, doc, resolver) {
        var xnode = node;
        if (xnode) {
            if (xnode.xmlElement) {
                return xnode.xmlElement;
            }
            else {
                xnode.xmlElement = this;
            }
        }
        this.node = node;
        this.doc = doc;
        this.resolver = resolver;
    }
    Object.defineProperty(XMLElement.prototype, "type", {
        get: function () {
            return this.node.nodeType;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(XMLElement.prototype, "value", {
        get: function () {
            return this.node.nodeValue;
        },
        set: function (value) {
            this.node.nodeValue = value;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(XMLElement.prototype, "firstElementChild", {
        get: function () {
            var node = this.node;
            if (isElement(node)) {
                return new XMLElement(node.firstElementChild, this.doc, this.resolver);
            }
            return null;
        },
        enumerable: true,
        configurable: true
    });
    XMLElement.prototype.appendChild = function (element) {
        this.node.appendChild(element.node);
    };
    XMLElement.prototype.orphan = function () {
        this.node.parentNode.removeChild(this.node);
    };
    XMLElement.prototype.empty = function () {
        var child;
        while (child = this.node.childNodes[0]) {
            this.node.removeChild(child);
        }
    };
    XMLElement.prototype.getString = function (expression, context) {
        if (context === void 0) { context = this.node; }
        return unescapeXML(this.evaluate(expression, context, XPathResult.STRING_TYPE).stringValue);
    };
    XMLElement.prototype.setString = function (expression, value, context) {
        if (context === void 0) { context = this.node; }
        var element = this.getElement(expression, context);
        if (element.type === 2) {
            throw new Error("Use 'setAttribute()' to set the value of an attribute");
        }
        if (element.type === 3) {
            element.value = escapeXML(value);
        }
        else {
            element.empty();
            element.node.appendChild(this.doc.createTextNode(value));
        }
    };
    XMLElement.prototype.getNumber = function (expression, context) {
        if (context === void 0) { context = this.node; }
        return this.evaluate(expression, context, XPathResult.NUMBER_TYPE).numberValue;
    };
    XMLElement.prototype.setNumber = function (expression, value, context) {
        if (context === void 0) { context = this.node; }
        this.setString(expression, value.toString());
    };
    XMLElement.prototype.getElement = function (expression, context) {
        if (context === void 0) { context = this.node; }
        var node = this.evaluate(expression, context, XPathResult.FIRST_ORDERED_NODE_TYPE).singleNodeValue;
        if (!node) {
            return null;
        }
        return new XMLElement(node, this.doc, this.resolver);
    };
    XMLElement.prototype.getElements = function (expression, context) {
        if (context === void 0) { context = this.node; }
        var result = [];
        var xpathResult = this.evaluate(expression, context, XPathResult.ORDERED_NODE_ITERATOR_TYPE);
        if (xpathResult) {
            var node = void 0;
            while ((node = xpathResult.iterateNext())) {
                result.push(new XMLElement(node, this.doc, this.resolver));
            }
        }
        return result;
    };
    XMLElement.prototype.getAttribute = function (name) {
        var node = this.node;
        if (isElement(node)) {
            return node.getAttribute(name) || "";
        }
        return "";
    };
    XMLElement.prototype.hasAttribute = function (name) {
        var node = this.node;
        if (isElement(node)) {
            return node.hasAttribute(name);
        }
        return false;
    };
    XMLElement.prototype.setAttribute = function (name, value) {
        var node = this.node;
        if (isElement(node)) {
            node.setAttribute(name, escapeXML(String(value)));
        }
    };
    XMLElement.prototype.removeAttribute = function (name) {
        var node = this.node;
        if (isElement(node)) {
            node.removeAttribute(name);
        }
    };
    XMLElement.prototype.evaluate = function (expression, context, type) {
        if (context === void 0) { context = this.node; }
        return this.doc.evaluate(expression, context, this.resolver, type, null);
    };
    return XMLElement;
}());
exports.XMLElement = XMLElement;
function namespaceMapToAttributes(namespaces) {
    var strings = [];
    Object.keys(namespaces).forEach(function (key) {
        var ns = key === "default" ? "" : ":" + key;
        strings.push("xmlns" + ns + "=\"" + namespaces[key] + "\"");
    });
    return strings.join(" ");
}
var XMLDocument = (function (_super) {
    __extends(XMLDocument, _super);
    function XMLDocument(doc, namespaces) {
        var _this = this;
        _super.call(this);
        var xdoc = doc;
        if (xdoc.xmlDocument) {
            return xdoc.xmlDocument;
        }
        xdoc.xmlDocument = this;
        this.doc = doc;
        this.namespaces = namespaces;
        this.resolver = function (prefix) {
            return _this.namespaces[prefix] || _this.namespaces.default;
        };
        this.node = doc.documentElement;
    }
    XMLDocument.fromString = function (content, namespaces) {
        if (!/^<\?xml /.test(content)) {
            var namespacesString = namespaceMapToAttributes(namespaces);
            content = "<?xml version=\"1.0\" encoding=\"utf-8\"?><root " + namespacesString + ">" + content + "</root>";
        }
        var parser = new DOMParser();
        var doc = parser.parseFromString(content, "text/xml");
        var xdoc = new XMLDocument(doc, namespaces);
        return xdoc;
    };
    XMLDocument.prototype.createElement = function (tag) {
        var _a = tag.split(":"), namespace = _a[0], tagName = _a[1];
        if (!tagName) {
            tagName = namespace;
            namespace = null;
        }
        var domElement;
        if (namespace) {
            domElement = this.doc.createElementNS(this.resolver(namespace), tagName);
        }
        else {
            domElement = this.doc.createElement(tagName);
        }
        return new XMLElement(domElement, this.doc, this.resolver);
    };
    XMLDocument.prototype.createElementTree = function (xml) {
        var doc = XMLDocument.fromString(xml, this.namespaces);
        return this.importElement(doc.firstElementChild);
    };
    XMLDocument.prototype.importElement = function (element) {
        var node = this.doc.importNode(element.node, true);
        return new XMLElement(node, this.doc, this.resolver);
    };
    XMLDocument.prototype.toString = function () {
        var serializer = new XMLSerializer();
        return serializer.serializeToString(this.doc);
    };
    return XMLDocument;
}(XMLElement));
exports.XMLDocument = XMLDocument;
function escapeXML(input) {
    return replaceMap(input, escapeXMLRE, escapeXMLMap);
}
exports.escapeXML = escapeXML;
function unescapeXML(input) {
    return replaceMap(input, unescapeXMLRE, unescapeXMLMap);
}
exports.unescapeXML = unescapeXML;
exports.xml = (function () {
    var escapeRE = /^:escape/;
    function xml(strings) {
        var values = [];
        for (var _i = 1; _i < arguments.length; _i++) {
            values[_i - 1] = arguments[_i];
        }
        var result = [strings[0]];
        values.forEach(function (value, index) {
            value = String(value);
            var nextString = strings[index + 1];
            if (escapeRE.test(nextString)) {
                value = escapeXML(value);
                nextString = nextString.replace(escapeRE, String.EMPTY);
            }
            result.push(value, nextString);
        });
        return result.join(String.EMPTY);
    }
    return xml;
})();
function replaceMap(input, regex, map) {
    return input.replace(regex, function (match) {
        return map[match];
    });
}
function isElement(node) {
    return node.nodeType === 1;
}

//# sourceMappingURL=data:application/json;base64,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QWEsRUFBRSxHQUFPO0lBQ3JELE1BQU0sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxVQUFVLEtBQUs7UUFDdkMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUN0QixDQUFDLENBQUMsQ0FBQztBQUNQLENBQUM7QUFFRCxtQkFBbUIsSUFBVTtJQUN6QixNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsS0FBSyxDQUFDLENBQUM7QUFDL0IsQ0FBQyIsImZpbGUiOiJjb21tb24veG1sLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTUsIFBhY2lmaWMgQmlvc2NpZW5jZXMgb2YgQ2FsaWZvcm5pYVxuICpcbiAqIENyZWF0ZWQgYnkgQnJ5YW4gRm9yYmVzIDxiZm9yYmVzQHBhY2lmaWNiaW9zY2llbmNlcy5jb20+IG9uIDMvMTYvMTYuXG4gKiBNb2RpZmllZCBieSBTYWwgU2FuZmlsaXBwbyA8c3NhbmZpbGlwcG9AcGFjaWZpY2Jpb3NjaWVuY2VzLmNvbT4gb24gMy8xNi8xNi5cbiAqL1xuXG5jb25zdCBlc2NhcGVYTUxNYXAgPSB7XG4gICAgXCImXCI6IFwiJmFtcDtcIixcbiAgICBcIlxcXCJcIjogXCImcXVvdDtcIixcbiAgICBcIidcIjogXCImYXBvcztcIixcbiAgICBcIjxcIjogXCImbHQ7XCIsXG4gICAgXCI+XCI6IFwiJmd0O1wiXG59O1xuXG5jb25zdCB1bmVzY2FwZVhNTE1hcCA9IHtcbiAgICBcIiZhbXA7XCI6IFwiJlwiLFxuICAgIFwiJnF1b3Q7XCI6IFwiXFxcIlwiLFxuICAgIFwiJmFwb3M7XCI6IFwiJ1wiLFxuICAgIFwiJmx0O1wiOiBcIjxcIixcbiAgICBcIiZndDtcIjogXCI+XCJcbn07XG5cbmNvbnN0IGVzY2FwZVhNTFJFID0gL1smXCInPD5dL2c7XG5jb25zdCB1bmVzY2FwZVhNTFJFID0gLyYoPzphbXB8cXVvdHxhcG9zfGx0fGd0KTsvZztcblxuaW50ZXJmYWNlIFhOb2RlIGV4dGVuZHMgTm9kZSB7XG4gICAgeG1sRWxlbWVudD86IFhNTEVsZW1lbnQ7XG59XG5cbmludGVyZmFjZSBYRG9jdW1lbnQgZXh0ZW5kcyBEb2N1bWVudCB7XG4gICAgeG1sRG9jdW1lbnQ/OiBYTUxEb2N1bWVudDtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBOYW1lc3BhY2VNYXAge1xuICAgIFtrZXk6IHN0cmluZ106IHN0cmluZztcbiAgICBkZWZhdWx0OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBjbGFzcyBYTUxFbGVtZW50IHtcbiAgICBnZXQgdHlwZSgpOiBudW1iZXIge1xuICAgICAgICByZXR1cm4gdGhpcy5ub2RlLm5vZGVUeXBlO1xuICAgIH1cblxuICAgIGdldCB2YWx1ZSgpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5ub2RlLm5vZGVWYWx1ZTtcbiAgICB9XG5cbiAgICBzZXQgdmFsdWUodmFsdWU6IHN0cmluZykge1xuICAgICAgICB0aGlzLm5vZGUubm9kZVZhbHVlID0gdmFsdWU7XG4gICAgfVxuXG4gICAgZ2V0IGZpcnN0RWxlbWVudENoaWxkKCk6IFhNTEVsZW1lbnQge1xuICAgICAgICBjb25zdCBub2RlID0gdGhpcy5ub2RlO1xuICAgICAgICBpZiAoaXNFbGVtZW50KG5vZGUpKSB7XG4gICAgICAgICAgICByZXR1cm4gbmV3IFhNTEVsZW1lbnQobm9kZS5maXJzdEVsZW1lbnRDaGlsZCwgdGhpcy5kb2MsIHRoaXMucmVzb2x2ZXIpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBkb2M6IERvY3VtZW50O1xuICAgIHByb3RlY3RlZCBub2RlOiBOb2RlO1xuICAgIHByb3RlY3RlZCByZXNvbHZlcjogKG5hbWVzcGFjZTogc3RyaW5nKSA9PiBzdHJpbmc7XG5cbiAgICBjb25zdHJ1Y3Rvcihub2RlPzogTm9kZSwgZG9jPzogRG9jdW1lbnQsIHJlc29sdmVyPzogKG5hbWVzcGFjZTogc3RyaW5nKSA9PiBzdHJpbmcpIHtcbiAgICAgICAgY29uc3QgeG5vZGU6IFhOb2RlID0gbm9kZTtcbiAgICAgICAgaWYgKHhub2RlKSB7XG4gICAgICAgICAgICAvLyBJZiB0aGlzIG5vZGUgaGFzIGJlZW4gYXNzaWduZWQgYW4gWE1MRWxlbWVudCwgcmV0dXJuIGl0IHNvXG4gICAgICAgICAgICAvLyBzdHJpY3QgZXF1YWxpdHkgYmV0d2VlbiByZXN1bHRzIG9mIFhNTEVsZW1lbnQgbWV0aG9kcyB3aWxsXG4gICAgICAgICAgICAvLyBzdGlsbCB3b3JrXG4gICAgICAgICAgICBpZiAoeG5vZGUueG1sRWxlbWVudCkge1xuICAgICAgICAgICAgICAgIHJldHVybiB4bm9kZS54bWxFbGVtZW50O1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB4bm9kZS54bWxFbGVtZW50ID0gdGhpcztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMubm9kZSA9IG5vZGU7XG4gICAgICAgIHRoaXMuZG9jID0gZG9jO1xuICAgICAgICB0aGlzLnJlc29sdmVyID0gcmVzb2x2ZXI7XG4gICAgfVxuXG4gICAgYXBwZW5kQ2hpbGQoZWxlbWVudDogWE1MRWxlbWVudCkge1xuICAgICAgICB0aGlzLm5vZGUuYXBwZW5kQ2hpbGQoZWxlbWVudC5ub2RlKTtcbiAgICB9XG5cbiAgICBvcnBoYW4oKSB7XG4gICAgICAgIHRoaXMubm9kZS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRoaXMubm9kZSk7XG4gICAgfVxuXG4gICAgZW1wdHkoKSB7XG4gICAgICAgIGxldCBjaGlsZDtcbiAgICAgICAgd2hpbGUgKGNoaWxkID0gdGhpcy5ub2RlLmNoaWxkTm9kZXNbMF0pIHtcbiAgICAgICAgICAgIHRoaXMubm9kZS5yZW1vdmVDaGlsZChjaGlsZCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBnZXRTdHJpbmcoZXhwcmVzc2lvbjogc3RyaW5nLCBjb250ZXh0OiBOb2RlID0gdGhpcy5ub2RlKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHVuZXNjYXBlWE1MKFxuICAgICAgICAgICAgdGhpcy5ldmFsdWF0ZShleHByZXNzaW9uLCBjb250ZXh0LCBYUGF0aFJlc3VsdC5TVFJJTkdfVFlQRSkuc3RyaW5nVmFsdWVcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBzZXRTdHJpbmcoZXhwcmVzc2lvbjogc3RyaW5nLCB2YWx1ZTogc3RyaW5nLCBjb250ZXh0OiBOb2RlID0gdGhpcy5ub2RlKSB7XG4gICAgICAgIGNvbnN0IGVsZW1lbnQgPSB0aGlzLmdldEVsZW1lbnQoZXhwcmVzc2lvbiwgY29udGV4dCk7XG4gICAgICAgIGlmIChlbGVtZW50LnR5cGUgPT09IDIpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIlVzZSAnc2V0QXR0cmlidXRlKCknIHRvIHNldCB0aGUgdmFsdWUgb2YgYW4gYXR0cmlidXRlXCIpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChlbGVtZW50LnR5cGUgPT09IDMpIHtcbiAgICAgICAgICAgIC8vIHRleHQgbm9kZXNcbiAgICAgICAgICAgIGVsZW1lbnQudmFsdWUgPSBlc2NhcGVYTUwodmFsdWUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZWxlbWVudC5lbXB0eSgpO1xuICAgICAgICAgICAgZWxlbWVudC5ub2RlLmFwcGVuZENoaWxkKHRoaXMuZG9jLmNyZWF0ZVRleHROb2RlKHZhbHVlKSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBnZXROdW1iZXIoZXhwcmVzc2lvbjogc3RyaW5nLCBjb250ZXh0OiBOb2RlID0gdGhpcy5ub2RlKTogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZXZhbHVhdGUoZXhwcmVzc2lvbiwgY29udGV4dCwgWFBhdGhSZXN1bHQuTlVNQkVSX1RZUEUpLm51bWJlclZhbHVlO1xuICAgIH1cblxuICAgIHNldE51bWJlcihleHByZXNzaW9uOiBzdHJpbmcsIHZhbHVlOiBudW1iZXIsIGNvbnRleHQ6IE5vZGUgPSB0aGlzLm5vZGUpIHtcbiAgICAgICAgdGhpcy5zZXRTdHJpbmcoZXhwcmVzc2lvbiwgdmFsdWUudG9TdHJpbmcoKSk7XG4gICAgfVxuXG4gICAgZ2V0RWxlbWVudChleHByZXNzaW9uOiBzdHJpbmcsIGNvbnRleHQ6IE5vZGUgPSB0aGlzLm5vZGUpOiBYTUxFbGVtZW50IHtcbiAgICAgICAgY29uc3Qgbm9kZSA9IHRoaXMuZXZhbHVhdGUoZXhwcmVzc2lvbiwgY29udGV4dCwgWFBhdGhSZXN1bHQuRklSU1RfT1JERVJFRF9OT0RFX1RZUEUpLnNpbmdsZU5vZGVWYWx1ZTtcbiAgICAgICAgaWYgKCFub2RlKSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbmV3IFhNTEVsZW1lbnQoXG4gICAgICAgICAgICBub2RlLFxuICAgICAgICAgICAgdGhpcy5kb2MsXG4gICAgICAgICAgICB0aGlzLnJlc29sdmVyXG4gICAgICAgICk7XG5cbiAgICB9XG5cbiAgICBnZXRFbGVtZW50cyhleHByZXNzaW9uOiBzdHJpbmcsIGNvbnRleHQ6IE5vZGUgPSB0aGlzLm5vZGUpOiBYTUxFbGVtZW50W10ge1xuICAgICAgICBjb25zdCByZXN1bHQ6IFhNTEVsZW1lbnRbXSA9IFtdO1xuXG4gICAgICAgIGNvbnN0IHhwYXRoUmVzdWx0ID0gdGhpcy5ldmFsdWF0ZShleHByZXNzaW9uLCBjb250ZXh0LCBYUGF0aFJlc3VsdC5PUkRFUkVEX05PREVfSVRFUkFUT1JfVFlQRSk7XG5cbiAgICAgICAgaWYgKHhwYXRoUmVzdWx0KSB7XG4gICAgICAgICAgICBsZXQgbm9kZTogTm9kZTtcbiAgICAgICAgICAgIHdoaWxlICgobm9kZSA9IHhwYXRoUmVzdWx0Lml0ZXJhdGVOZXh0KCkpKSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2gobmV3IFhNTEVsZW1lbnQobm9kZSwgdGhpcy5kb2MsIHRoaXMucmVzb2x2ZXIpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuXG4gICAgZ2V0QXR0cmlidXRlKG5hbWU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIGNvbnN0IG5vZGUgPSB0aGlzLm5vZGU7XG4gICAgICAgIGlmIChpc0VsZW1lbnQobm9kZSkpIHtcbiAgICAgICAgICAgIHJldHVybiBub2RlLmdldEF0dHJpYnV0ZShuYW1lKSB8fCBcIlwiO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBcIlwiO1xuICAgIH1cblxuICAgIGhhc0F0dHJpYnV0ZShuYW1lOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAgICAgY29uc3Qgbm9kZSA9IHRoaXMubm9kZTtcbiAgICAgICAgaWYgKGlzRWxlbWVudChub2RlKSkge1xuICAgICAgICAgICAgcmV0dXJuIG5vZGUuaGFzQXR0cmlidXRlKG5hbWUpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBzZXRBdHRyaWJ1dGUobmFtZTogc3RyaW5nLCB2YWx1ZTogYW55KSB7XG4gICAgICAgIGNvbnN0IG5vZGUgPSB0aGlzLm5vZGU7XG4gICAgICAgIGlmIChpc0VsZW1lbnQobm9kZSkpIHtcbiAgICAgICAgICAgIG5vZGUuc2V0QXR0cmlidXRlKG5hbWUsIGVzY2FwZVhNTChTdHJpbmcodmFsdWUpKSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICByZW1vdmVBdHRyaWJ1dGUobmFtZTogc3RyaW5nKSB7XG4gICAgICAgIGNvbnN0IG5vZGUgPSB0aGlzLm5vZGU7XG4gICAgICAgIGlmIChpc0VsZW1lbnQobm9kZSkpIHtcbiAgICAgICAgICAgIG5vZGUucmVtb3ZlQXR0cmlidXRlKG5hbWUpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBldmFsdWF0ZShleHByZXNzaW9uOiBzdHJpbmcsIGNvbnRleHQ6IE5vZGUgPSB0aGlzLm5vZGUsIHR5cGU6IG51bWJlcik6IFhQYXRoUmVzdWx0IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZG9jLmV2YWx1YXRlKGV4cHJlc3Npb24sIGNvbnRleHQsIDxhbnk+IHRoaXMucmVzb2x2ZXIsIHR5cGUsIG51bGwpO1xuICAgIH1cbn1cblxuZnVuY3Rpb24gbmFtZXNwYWNlTWFwVG9BdHRyaWJ1dGVzKG5hbWVzcGFjZXM6IE5hbWVzcGFjZU1hcCk6IHN0cmluZyB7XG4gICAgY29uc3Qgc3RyaW5nczogc3RyaW5nW10gPSBbXTtcblxuICAgIE9iamVjdC5rZXlzKG5hbWVzcGFjZXMpLmZvckVhY2goa2V5ID0+IHtcbiAgICAgICAgY29uc3QgbnMgPSBrZXkgPT09IFwiZGVmYXVsdFwiID8gXCJcIiA6IGA6JHtrZXl9YDtcbiAgICAgICAgc3RyaW5ncy5wdXNoKGB4bWxucyR7bnN9PVwiJHtuYW1lc3BhY2VzW2tleV19XCJgKTtcbiAgICB9KTtcblxuICAgIHJldHVybiBzdHJpbmdzLmpvaW4oXCIgXCIpO1xufVxuXG5leHBvcnQgY2xhc3MgWE1MRG9jdW1lbnQgZXh0ZW5kcyBYTUxFbGVtZW50IHtcbiAgICBwcm90ZWN0ZWQgbmFtZXNwYWNlczogTmFtZXNwYWNlTWFwO1xuXG4gICAgY29uc3RydWN0b3IoZG9jOiBEb2N1bWVudCwgbmFtZXNwYWNlczogTmFtZXNwYWNlTWFwKSB7XG4gICAgICAgIHN1cGVyKCk7XG5cbiAgICAgICAgY29uc3QgeGRvYzogWERvY3VtZW50ID0gZG9jO1xuICAgICAgICBpZiAoeGRvYy54bWxEb2N1bWVudCkge1xuICAgICAgICAgICAgcmV0dXJuIHhkb2MueG1sRG9jdW1lbnQ7XG4gICAgICAgIH1cblxuICAgICAgICB4ZG9jLnhtbERvY3VtZW50ID0gdGhpcztcblxuICAgICAgICB0aGlzLmRvYyA9IGRvYztcbiAgICAgICAgdGhpcy5uYW1lc3BhY2VzID0gbmFtZXNwYWNlcztcbiAgICAgICAgdGhpcy5yZXNvbHZlciA9IChwcmVmaXg6IHN0cmluZyk6IHN0cmluZyA9PiB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5uYW1lc3BhY2VzW3ByZWZpeF0gfHwgdGhpcy5uYW1lc3BhY2VzLmRlZmF1bHQ7XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMubm9kZSA9IGRvYy5kb2N1bWVudEVsZW1lbnQ7XG4gICAgfVxuXG4gICAgc3RhdGljIGZyb21TdHJpbmcoY29udGVudDogc3RyaW5nLCBuYW1lc3BhY2VzOiBOYW1lc3BhY2VNYXApOiBYTUxEb2N1bWVudCB7XG4gICAgICAgIGlmICghL148XFw/eG1sIC8udGVzdChjb250ZW50KSkge1xuICAgICAgICAgICAgY29uc3QgbmFtZXNwYWNlc1N0cmluZyA9IG5hbWVzcGFjZU1hcFRvQXR0cmlidXRlcyhuYW1lc3BhY2VzKTtcbiAgICAgICAgICAgIGNvbnRlbnQgPSBgPD94bWwgdmVyc2lvbj1cIjEuMFwiIGVuY29kaW5nPVwidXRmLThcIj8+PHJvb3QgJHtuYW1lc3BhY2VzU3RyaW5nfT4ke2NvbnRlbnR9PC9yb290PmA7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBwYXJzZXIgPSBuZXcgRE9NUGFyc2VyKCk7XG4gICAgICAgIGNvbnN0IGRvYyA9IHBhcnNlci5wYXJzZUZyb21TdHJpbmcoY29udGVudCwgXCJ0ZXh0L3htbFwiKTtcbiAgICAgICAgY29uc3QgeGRvYyA9IG5ldyBYTUxEb2N1bWVudChkb2MsIG5hbWVzcGFjZXMpO1xuXG4gICAgICAgIHJldHVybiB4ZG9jO1xuICAgIH1cblxuICAgIGNyZWF0ZUVsZW1lbnQodGFnOiBzdHJpbmcpOiBYTUxFbGVtZW50IHtcbiAgICAgICAgbGV0IFtuYW1lc3BhY2UsIHRhZ05hbWVdID0gdGFnLnNwbGl0KFwiOlwiKTtcbiAgICAgICAgaWYgKCF0YWdOYW1lKSB7XG4gICAgICAgICAgICB0YWdOYW1lID0gbmFtZXNwYWNlO1xuICAgICAgICAgICAgbmFtZXNwYWNlID0gbnVsbDtcbiAgICAgICAgfVxuICAgICAgICBsZXQgZG9tRWxlbWVudDtcbiAgICAgICAgaWYgKG5hbWVzcGFjZSkge1xuICAgICAgICAgICAgZG9tRWxlbWVudCA9IHRoaXMuZG9jLmNyZWF0ZUVsZW1lbnROUyh0aGlzLnJlc29sdmVyKG5hbWVzcGFjZSksIHRhZ05hbWUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZG9tRWxlbWVudCA9IHRoaXMuZG9jLmNyZWF0ZUVsZW1lbnQodGFnTmFtZSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG5ldyBYTUxFbGVtZW50KGRvbUVsZW1lbnQsIHRoaXMuZG9jLCB0aGlzLnJlc29sdmVyKTtcbiAgICB9XG5cbiAgICBjcmVhdGVFbGVtZW50VHJlZSh4bWw6IHN0cmluZyk6IFhNTEVsZW1lbnQge1xuICAgICAgICBjb25zdCBkb2MgPSBYTUxEb2N1bWVudC5mcm9tU3RyaW5nKHhtbCwgdGhpcy5uYW1lc3BhY2VzKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuaW1wb3J0RWxlbWVudChkb2MuZmlyc3RFbGVtZW50Q2hpbGQpO1xuICAgIH1cblxuICAgIGltcG9ydEVsZW1lbnQoZWxlbWVudDogWE1MRWxlbWVudCk6IFhNTEVsZW1lbnQge1xuICAgICAgICBjb25zdCBub2RlID0gdGhpcy5kb2MuaW1wb3J0Tm9kZSgoPGFueT4gZWxlbWVudCkubm9kZSwgdHJ1ZSk7XG4gICAgICAgIHJldHVybiBuZXcgWE1MRWxlbWVudChub2RlLCB0aGlzLmRvYywgdGhpcy5yZXNvbHZlcik7XG4gICAgfVxuXG4gICAgdG9TdHJpbmcoKTogc3RyaW5nIHtcbiAgICAgICAgY29uc3Qgc2VyaWFsaXplciA9IG5ldyBYTUxTZXJpYWxpemVyKCk7XG4gICAgICAgIHJldHVybiBzZXJpYWxpemVyLnNlcmlhbGl6ZVRvU3RyaW5nKHRoaXMuZG9jKTtcbiAgICB9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXR0cmlidXRlTWFwIHtcbiAgICBba2V5OiBzdHJpbmddOiBzdHJpbmc7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBlc2NhcGVYTUwoaW5wdXQ6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHJlcGxhY2VNYXAoaW5wdXQsIGVzY2FwZVhNTFJFLCBlc2NhcGVYTUxNYXApO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gdW5lc2NhcGVYTUwoaW5wdXQ6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHJlcGxhY2VNYXAoaW5wdXQsIHVuZXNjYXBlWE1MUkUsIHVuZXNjYXBlWE1MTWFwKTtcbn1cblxuZXhwb3J0IGNvbnN0IHhtbCA9IChmdW5jdGlvbiAoKSB7XG4gICAgY29uc3QgZXNjYXBlUkUgPSAvXjplc2NhcGUvO1xuICAgIGZ1bmN0aW9uIHhtbChzdHJpbmdzOiBzdHJpbmdbXSwgLi4udmFsdWVzOiBhbnlbXSkge1xuICAgICAgICBjb25zdCByZXN1bHQgPSBbc3RyaW5nc1swXV07XG4gICAgICAgIHZhbHVlcy5mb3JFYWNoKCh2YWx1ZSwgaW5kZXgpID0+IHtcbiAgICAgICAgICAgIHZhbHVlID0gU3RyaW5nKHZhbHVlKTtcbiAgICAgICAgICAgIGxldCBuZXh0U3RyaW5nID0gc3RyaW5nc1tpbmRleCArIDFdO1xuICAgICAgICAgICAgaWYgKGVzY2FwZVJFLnRlc3QobmV4dFN0cmluZykpIHtcbiAgICAgICAgICAgICAgICB2YWx1ZSA9IGVzY2FwZVhNTCh2YWx1ZSk7XG4gICAgICAgICAgICAgICAgbmV4dFN0cmluZyA9IG5leHRTdHJpbmcucmVwbGFjZShlc2NhcGVSRSwgU3RyaW5nLkVNUFRZKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJlc3VsdC5wdXNoKHZhbHVlLCBuZXh0U3RyaW5nKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiByZXN1bHQuam9pbihTdHJpbmcuRU1QVFkpO1xuICAgIH1cbiAgICByZXR1cm4geG1sO1xufSkoKTtcblxuZnVuY3Rpb24gcmVwbGFjZU1hcChpbnB1dDogc3RyaW5nLCByZWdleDogUmVnRXhwLCBtYXA6IHt9KSB7XG4gICAgcmV0dXJuIGlucHV0LnJlcGxhY2UocmVnZXgsIGZ1bmN0aW9uIChtYXRjaCkge1xuICAgICAgICByZXR1cm4gbWFwW21hdGNoXTtcbiAgICB9KTtcbn1cblxuZnVuY3Rpb24gaXNFbGVtZW50KG5vZGU6IE5vZGUpOiBub2RlIGlzIEVsZW1lbnQge1xuICAgIHJldHVybiBub2RlLm5vZGVUeXBlID09PSAxO1xufVxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9